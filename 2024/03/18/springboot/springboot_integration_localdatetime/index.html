<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.0/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"example.com",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",width:300,display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"default"},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="一、为什么使用LocalDateTimeLocalDateTime 和 Date 是 Java 中处理日期和时间的两种不同的类，在 JDK8 中引入了 java.time 包。LocalDateTime 相比 Date 有一些优势，主要体现在以下几个方面："><meta property="og:type" content="article"><meta property="og:title" content="SpringBoot整合LocalDateTime"><meta property="og:url" content="http://example.com/2024/03/18/springboot/springboot_integration_localdatetime/index.html"><meta property="og:site_name" content="Peace Fish&#39;s Blog Zone"><meta property="og:description" content="一、为什么使用LocalDateTimeLocalDateTime 和 Date 是 Java 中处理日期和时间的两种不同的类，在 JDK8 中引入了 java.time 包。LocalDateTime 相比 Date 有一些优势，主要体现在以下几个方面："><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2024-03-18T14:13:59.000Z"><meta property="article:modified_time" content="2024-03-18T14:17:56.040Z"><meta property="article:author" content="独辟蹊径的鱼"><meta property="article:tag" content="springboot"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://example.com/2024/03/18/springboot/springboot_integration_localdatetime/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>SpringBoot整合LocalDateTime | Peace Fish's Blog Zone</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script><script src="/live2d-widget/autoload.js"></script></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Peace Fish's Blog Zone</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">hello, world</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2024/03/18/springboot/springboot_integration_localdatetime/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="独辟蹊径的鱼"><meta itemprop="description" content="一个简单的博客"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Peace Fish's Blog Zone"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">SpringBoot整合LocalDateTime</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2024-03-18 22:13:59 / 修改时间：22:17:56" itemprop="dateCreated datePublished" datetime="2024-03-18T22:13:59+08:00">2024-03-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springboot/" itemprop="url" rel="index"><span itemprop="name">springboot</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="一、为什么使用LocalDateTime"><a href="#一、为什么使用LocalDateTime" class="headerlink" title="一、为什么使用LocalDateTime"></a>一、为什么使用LocalDateTime</h1><p>LocalDateTime 和 Date 是 Java 中处理日期和时间的两种不同的类，在 JDK8 中引入了 java.time 包。LocalDateTime 相比 Date 有一些优势，主要体现在以下几个方面：</p><span id="more"></span><ul><li>不可变性（Immutability）：<ul><li>LocalDateTime 是不可变的类，一旦创建就不能被修改。任何对 LocalDateTime 的操作都会返回一个新的对象，而不会修改原始对象。这有助于避免在多线程环境中的并发问题。</li></ul></li><li>线程安全性：<ul><li>由于 LocalDateTime 是不可变的，因此它天然具有线程安全性，可以在多线程环境中安全使用。</li></ul></li><li>可读性和易用性：<ul><li>LocalDateTime 提供了更加清晰和直观的API，使得处理日期和时间更加易读、易用。例如，通过使用方法链式调用，可以轻松地执行各种操作，而不需要复杂的日期格式化和解析。</li></ul></li><li>更好的API设计：<ul><li>LocalDateTime 提供了更丰富、灵活和易用的API，允许进行各种日期和时间的操作，例如增减天数、小时、分钟等。而 Date 的 API相对较为古老和不够直观。</li></ul></li><li>时区处理：<ul><li>LocalDateTime 能够更好地处理时区信息，通过 ZonedDateTime 类可以轻松转换到不同的时区。而 Date 类在处理时区时较为复杂，通常需要使用 Calendar 类。</li></ul></li></ul><p>总的来说，LocalDateTime 提供了更现代、清晰和强大的日期和时间处理功能，使得开发者更容易编写可读性高且可维护性强的代码。在新的代码中，特别是在使用 JDK 8 及更新版本的项目中，推荐使用 LocalDateTime 替代 Date。</p><h1 id="二、使用LocalDateTime遇到的问题"><a href="#二、使用LocalDateTime遇到的问题" class="headerlink" title="二、使用LocalDateTime遇到的问题"></a>二、使用LocalDateTime遇到的问题</h1><p>众所周知，SpringBoot会自动对前端的传值进行解析，将 HttpServletRequest 中的请求内容，转换成后端 Controoler 控制器中的实体类参数，但在实际使用 LocalDateTime 作用参数时，我们会发现 SpringBoot 好像不能正常工作了，下面是两个问题例子。</p><ul><li>GET请求使用 LocalDateTime 作为参数</li></ul><p>下面是使用 @RequestParam 和 @PathVariable 两种最常见的用法示例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalDateTimeController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/resolveRequestParamDateTime&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resolveRequestParamDateTime</span><span class="params">(<span class="meta">@RequestParam</span> LocalDateTime dateTime)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/resolvePathVariableDateTime/&#123;dateTime&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resolvePathVariableDateTime</span><span class="params">(<span class="meta">@PathVariable</span> LocalDateTime dateTime)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>点击运行，无论是第一个还是第二个方法，都会出现如下异常</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.method.annotation.MethodArgumentTypeMismatchException: Failed to convert value of type <span class="string">&#x27;java.lang.String&#x27;</span> to required type <span class="string">&#x27;java.time.LocalDateTime&#x27;</span>; nested exception is org.springframework.core.convert.ConversionFailedException: Failed to convert from type [java.lang.String] to type [<span class="meta">@org</span>.springframework.web.bind.annotation.PathVariable java.time.LocalDateTime] <span class="keyword">for</span> value <span class="string">&#x27;2023-01-01 12:12:12&#x27;</span>; nested exception is java.lang.IllegalArgumentException: Parse attempt failed <span class="keyword">for</span> value [<span class="number">2023</span>-<span class="number">01</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">12</span>:<span class="number">12</span>]</span><br><span class="line">	at org.springframework.web.method.annotation.AbstractNamedValueMethodArgumentResolver.resolveArgument(AbstractNamedValueMethodArgumentResolver.java:<span class="number">133</span>)</span><br><span class="line">	at org.springframework.web.method.support.HandlerMethodArgumentResolverComposite.resolveArgument(HandlerMethodArgumentResolverComposite.java:<span class="number">121</span>)</span><br><span class="line"></span><br><span class="line">Caused by: org.springframework.core.convert.ConversionFailedException: Failed to convert from type [java.lang.String] to type [<span class="meta">@org</span>.springframework.web.bind.annotation.PathVariable java.time.LocalDateTime] <span class="keyword">for</span> value <span class="string">&#x27;2023-01-01 12:12:12&#x27;</span>; nested exception is java.lang.IllegalArgumentException: Parse attempt failed <span class="keyword">for</span> value [<span class="number">2023</span>-<span class="number">01</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">12</span>:<span class="number">12</span>]</span><br><span class="line">	at org.springframework.core.convert.support.ConversionUtils.invokeConverter(ConversionUtils.java:<span class="number">47</span>)</span><br><span class="line">	at org.springframework.core.convert.support.GenericConversionService.convert(GenericConversionService.java:<span class="number">191</span>)</span><br><span class="line"></span><br><span class="line">Caused by: java.lang.IllegalArgumentException: Parse attempt failed <span class="keyword">for</span> value [<span class="number">2023</span>-<span class="number">01</span>-<span class="number">01</span> <span class="number">12</span>:<span class="number">12</span>:<span class="number">12</span>]</span><br><span class="line">	at org.springframework.format.support.FormattingConversionService$ParserConverter.convert(FormattingConversionService.java:<span class="number">223</span>)</span><br><span class="line"></span><br><span class="line">Caused by: java.time.format.DateTimeParseException: Text <span class="string">&#x27;2023-01-01 12:12:12&#x27;</span> could not be parsed at index <span class="number">2</span></span><br><span class="line">	at java.time.format.DateTimeFormatter.parseResolved0(DateTimeFormatter.java:<span class="number">1949</span>)</span><br></pre></td></tr></table></figure><ul><li><p>POST请求体中使用 LocalDateTime 作为参数<br>下面是使用 @RequestBody 的示例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalDateTimeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/resolveBodyDateTime&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resolveBodyDateTime</span><span class="params">(<span class="meta">@RequestBody</span> ResolveBody body)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ResolveBody</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> LocalDateTime dateTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>点击运行，会出现如下异常</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.http.converter.HttpMessageNotReadableException: JSON parse error: Expected array or string.; nested exception is com.fasterxml.jackson.databind.exc.MismatchedInputException: Expected array or string.</span><br><span class="line"> at [Source: (PushbackInputStream); line: <span class="number">1</span>, column: <span class="number">1</span>]</span><br><span class="line">	at org.springframework.http.converter.json.AbstractJackson2HttpMessageConverter.readJavaType(AbstractJackson2HttpMessageConverter.java:<span class="number">245</span>)</span><br><span class="line">	at org.springframework.http.converter.json.AbstractJackson2HttpMessageConverter.read(AbstractJackson2HttpMessageConverter.java:<span class="number">227</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodArgumentResolver.readWithMessageConverters(AbstractMessageConverterMethodArgumentResolver.java:<span class="number">205</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor.readWithMessageConverters(RequestResponseBodyMethodProcessor.java:<span class="number">158</span>)</span><br><span class="line">	at org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor.resolveArgument(RequestResponseBodyMethodProcessor.java:<span class="number">131</span>)</span><br><span class="line">	at org.springframework.web.method.support.HandlerMethodArgumentResolverComposite.resolveArgument(HandlerMethodArgumentResolverComposite.java:<span class="number">121</span>)</span><br><span class="line"></span><br><span class="line">Caused by: com.fasterxml.jackson.databind.exc.MismatchedInputException: Expected array or string.</span><br><span class="line"> at [Source: (PushbackInputStream); line: <span class="number">1</span>, column: <span class="number">1</span>]</span><br><span class="line">	at com.fasterxml.jackson.databind.exc.MismatchedInputException.from(MismatchedInputException.java:<span class="number">59</span>)</span><br><span class="line">	at com.fasterxml.jackson.databind.DeserializationContext.reportInputMismatch(DeserializationContext.java:<span class="number">1442</span>)</span><br></pre></td></tr></table></figure></li><li><p>简单分析</p></li></ul><p>观察堆栈错误信息，在使用 GET 请求时抛出的异常的 MethodArgumentTypeMismatchException ，而使用 POST请求时抛出的异常是 HttpMessageNotReadableException 。<br>二者最外层抛出的异常不一样，但是我们继续往下看最内层抛出的异常， GET 请求的报错很明显就是 String 类型不能被转换为 LocalDateTime 类型抛出的异常，POST请求抛出的是 jackson 反序列化类型不匹配的异常。<br>通过分析可得，上述 GET 和 POST 请求的报错，都是由于 SpringBoot 未能正常将参数中 String 类型转换为 LocalDateTime 类型抛出的。</p><h1 id="三、异常源码分析"><a href="#三、异常源码分析" class="headerlink" title="三、异常源码分析"></a>三、异常源码分析</h1><p>通过堆栈信息可以看出，我们的请求链路在进行参数解析，也就是走到spring mvc 的HandlerMethodArgumentResolverComposite.resolveArgument()这个方法时发生的异常，从这个方法入手debug打断点依次往下执行，一直走到最内层的堆栈位置，也就是实际进行参数解析的核心代码，下面列出实际参数解析代码。</p><ul><li>GET请求</li></ul><p>第13行就是实际的转换代码，走到这里时spring拿到的converter是通过WebMvcAutoConfiguration类自动装配注入的FormattingConversionService对象 ，但是这个converter默认情况下并不能将String转换为LocalDateTime</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">convert</span><span class="params">(<span class="meta">@Nullable</span> Object source, <span class="meta">@Nullable</span> TypeDescriptor sourceType, TypeDescriptor targetType)</span> &#123;</span><br><span class="line">    Assert.notNull(targetType, <span class="string">&quot;Target type to convert to cannot be null&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (sourceType == <span class="literal">null</span>) &#123;</span><br><span class="line">        Assert.isTrue(source == <span class="literal">null</span>, <span class="string">&quot;Source must be [null] if source type == [null]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.handleResult((TypeDescriptor)<span class="literal">null</span>, targetType, <span class="built_in">this</span>.convertNullSource((TypeDescriptor)<span class="literal">null</span>, targetType));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (source != <span class="literal">null</span> &amp;&amp; !sourceType.getObjectType().isInstance(source)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Source to convert from must be an instance of [&quot;</span> + sourceType + <span class="string">&quot;]; instead it was a [&quot;</span> + source.getClass().getName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">GenericConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="built_in">this</span>.getConverter(sourceType, targetType);</span><br><span class="line">        <span class="keyword">if</span> (converter != <span class="literal">null</span>) &#123;</span><br><span class="line">            # 这里去做类型转换</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> ConversionUtils.invokeConverter(converter, source, sourceType, targetType);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.handleResult(sourceType, targetType, result);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.handleConverterNotFound(source, sourceType, targetType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>POST请求<br>在第11~12行就是实际的转换代码，走到这里时spring拿到的converter是 MappingJackson2HttpMessageConverter ，但是这个converter并不能将String转换为LocalDateTime</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : <span class="built_in">this</span>.messageConverters) &#123;</span><br><span class="line">    Class&lt;HttpMessageConverter&lt;?&gt;&gt; converterType = (Class&lt;HttpMessageConverter&lt;?&gt;&gt;) converter.getClass();</span><br><span class="line">    GenericHttpMessageConverter&lt;?&gt; genericConverter =</span><br><span class="line">    (converter <span class="keyword">instanceof</span> GenericHttpMessageConverter ? (GenericHttpMessageConverter&lt;?&gt;) converter : <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">if</span> (genericConverter != <span class="literal">null</span> ? genericConverter.canRead(targetType, contextClass, contentType) :</span><br><span class="line">        (targetClass != <span class="literal">null</span> &amp;&amp; converter.canRead(targetClass, contentType))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (message.hasBody()) &#123;</span><br><span class="line">            <span class="type">HttpInputMessage</span> <span class="variable">msgToUse</span> <span class="operator">=</span></span><br><span class="line">            getAdvice().beforeBodyRead(message, parameter, targetType, converterType);</span><br><span class="line">            # 这里去做类型转换</span><br><span class="line">            body = (genericConverter != <span class="literal">null</span> ? genericConverter.read(targetType, contextClass, msgToUse) :</span><br><span class="line">                    ((HttpMessageConverter&lt;T&gt;) converter).read(targetClass, msgToUse));</span><br><span class="line">            body = getAdvice().afterBodyRead(body, msgToUse, parameter, targetType, converterType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            body = getAdvice().handleEmptyBody(<span class="literal">null</span>, message, parameter, targetType, converterType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MappingJackson2HttpMessageConverter的read解析方法继续往后走，调用的是父类AbstractJackson2HttpMessageConverter的read方法，实际的解析方法就是第18行的ObjectMapper类的readValue方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Object <span class="title function_">read</span><span class="params">(Type type, <span class="meta">@Nullable</span> Class&lt;?&gt; contextClass, HttpInputMessage inputMessage)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, HttpMessageNotReadableException &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">JavaType</span> <span class="variable">javaType</span> <span class="operator">=</span> getJavaType(type, contextClass);</span><br><span class="line">		<span class="keyword">return</span> readJavaType(javaType, inputMessage);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Object <span class="title function_">readJavaType</span><span class="params">(JavaType javaType, HttpInputMessage inputMessage)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (inputMessage <span class="keyword">instanceof</span> MappingJacksonInputMessage) &#123;</span><br><span class="line">				Class&lt;?&gt; deserializationView = ((MappingJacksonInputMessage) inputMessage).getDeserializationView();</span><br><span class="line">				<span class="keyword">if</span> (deserializationView != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="built_in">this</span>.objectMapper.readerWithView(deserializationView).forType(javaType).</span><br><span class="line">							readValue(inputMessage.getBody());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">            # jackson实际解析</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">this</span>.objectMapper.readValue(inputMessage.getBody(), javaType);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (InvalidDefinitionException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpMessageConversionException</span>(<span class="string">&quot;Type definition error: &quot;</span> + ex.getType(), ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (JsonProcessingException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HttpMessageNotReadableException</span>(<span class="string">&quot;JSON parse error: &quot;</span> + ex.getOriginalMessage(), ex, inputMessage);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></li><li><p>问题分析</p></li></ul><p>SpringBoot GET请求参数类型转换使用的是GenericConversionService类里注册的一个个GenericConverter；String转LocalDateTime类型默认情况下的StringToLocalDateTimeConverter不能正常解析。<br>SpringBoot POST请求参数类型转换使用的是AbstractMessageConverterMethodArgumentResolver类里List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters里注册的一个个HttpMessageConverter；String转LocalDateTime类型默认情况下的MappingJackson2HttpMessageConverter不能正常解析，也就是默认的ObjectMapper不能正常解析。</p><h1 id="四、解决思路"><a href="#四、解决思路" class="headerlink" title="四、解决思路"></a>四、解决思路</h1><p>通过上述问题分析，下面有两种解决思路（推荐第二种）</p><ul><li>通过配置使得默认的StringToLocalDateTimeConverter支持GET请求String转LocalDateTime类型，默认的MappingJackson2HttpMessageConverter支持POST请求String转LocalDateTime类型</li><li>spring注入GenericConverter类型的Bean支持GET请求String转LocalDateTime类型，注入ObjectMapper类型的Bean支持POST请求String转LocalDateTime类型</li></ul><h2 id="4-1、GET请求解决思路"><a href="#4-1、GET请求解决思路" class="headerlink" title="4.1、GET请求解决思路"></a>4.1、GET请求解决思路</h2><pre><code>  GET请求解决思路，通过阅读源码，可以发现以下三种springboot为用户预留出来的实现方式：
</code></pre><ul><li>application.yml配置</li></ul><p>在2.3.x以上版本，springmvc增加了日期时间格式配置，并且可以将格式注册到对应的日期解析器中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// springboot自动装配WebConversionService对象</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> FormattingConversionService <span class="title function_">mvcConversionService</span><span class="params">()</span> &#123;</span><br><span class="line">    WebMvcProperties.<span class="type">Format</span> <span class="variable">format</span> <span class="operator">=</span> <span class="built_in">this</span>.mvcProperties.getFormat();</span><br><span class="line">    <span class="type">WebConversionService</span> <span class="variable">conversionService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebConversionService</span>((<span class="keyword">new</span> <span class="title class_">DateTimeFormatters</span>()).dateFormat(format.getDate()).timeFormat(format.getTime()).dateTimeFormat(format.getDateTime()));</span><br><span class="line">    <span class="comment">// 这里允许用户自定往容器中添加Converter</span></span><br><span class="line">    <span class="built_in">this</span>.addFormatters(conversionService);</span><br><span class="line">    <span class="keyword">return</span> conversionService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addFormatters</span><span class="params">(DateTimeFormatters dateTimeFormatters)</span> &#123;</span><br><span class="line">    <span class="comment">// 这是默认情况下springboot自动注入的日期格式解析器</span></span><br><span class="line">    <span class="built_in">this</span>.registerJsr310(dateTimeFormatters);</span><br><span class="line">    <span class="built_in">this</span>.registerJavaDate(dateTimeFormatters);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">registerJsr310就是注册LocalDateTime日期解析器的具体方法，继续往里走中我们可以看到这一行代码</span><br><span class="line">registry.addFormatterForFieldAnnotation(<span class="keyword">new</span> <span class="title class_">Jsr310DateTimeFormatAnnotationFormatterFactory</span>());</span><br><span class="line">所以我们可以知道</span><br></pre></td></tr></table></figure><ul><li><p>使用@DateTimeFormat注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerFormatters</span><span class="params">(FormatterRegistry registry)</span> &#123;</span><br><span class="line">    <span class="comment">// 这里可以拿到application.yml配置文件指定的格式</span></span><br><span class="line">    <span class="type">DateTimeFormatter</span> <span class="variable">df</span> <span class="operator">=</span> <span class="built_in">this</span>.getFormatter(DateTimeFormatterRegistrar.Type.DATE);</span><br><span class="line">    <span class="type">DateTimeFormatter</span> <span class="variable">tf</span> <span class="operator">=</span> <span class="built_in">this</span>.getFormatter(DateTimeFormatterRegistrar.Type.TIME);</span><br><span class="line">    <span class="type">DateTimeFormatter</span> <span class="variable">dtf</span> <span class="operator">=</span> <span class="built_in">this</span>.getFormatter(DateTimeFormatterRegistrar.Type.DATE_TIME);</span><br><span class="line">    registry.addFormatterForFieldType(LocalDate.class, <span class="keyword">new</span> <span class="title class_">TemporalAccessorPrinter</span>(df == DateTimeFormatter.ISO_DATE ? DateTimeFormatter.ISO_LOCAL_DATE : df), <span class="keyword">new</span> <span class="title class_">TemporalAccessorParser</span>(LocalDate.class, df));</span><br><span class="line">    registry.addFormatterForFieldType(LocalTime.class, <span class="keyword">new</span> <span class="title class_">TemporalAccessorPrinter</span>(tf == DateTimeFormatter.ISO_TIME ? DateTimeFormatter.ISO_LOCAL_TIME : tf), <span class="keyword">new</span> <span class="title class_">TemporalAccessorParser</span>(LocalTime.class, tf));</span><br><span class="line">    registry.addFormatterForFieldType(LocalDateTime.class, <span class="keyword">new</span> <span class="title class_">TemporalAccessorPrinter</span>(dtf == DateTimeFormatter.ISO_DATE_TIME ? DateTimeFormatter.ISO_LOCAL_DATE_TIME : dtf), <span class="keyword">new</span> <span class="title class_">TemporalAccessorParser</span>(LocalDateTime.class, dtf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用@DateTimeFormat注解来帮忙完成LocalDateTime类型的解析</span></span><br><span class="line">    registry.addFormatterForFieldAnnotation(<span class="keyword">new</span> <span class="title class_">Jsr310DateTimeFormatAnnotationFormatterFactory</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>向容器中添加自定义Converter</p></li></ul><p>我们在WebConversionService对象自动装配方法中看到了这行代码：<code>this.addFormatters(conversionService);</code>这其实就是springboot为用户预留的拓展方法，它支持用户向容器中添加自定义Converter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WebMvcAutoConfiguration.WebMvcAutoConfigurationAdapter#addFormatters()方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFormatters</span><span class="params">(FormatterRegistry registry)</span> &#123;</span><br><span class="line">    ApplicationConversionService.addBeans(registry, <span class="built_in">this</span>.beanFactory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ApplicationConversionService#addBeans()方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addBeans</span><span class="params">(FormatterRegistry registry, ListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">    Set&lt;Object&gt; beans = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>();</span><br><span class="line">    beans.addAll(beanFactory.getBeansOfType(GenericConverter.class).values());</span><br><span class="line">    beans.addAll(beanFactory.getBeansOfType(Converter.class).values());</span><br><span class="line">    beans.addAll(beanFactory.getBeansOfType(Printer.class).values());</span><br><span class="line">    beans.addAll(beanFactory.getBeansOfType(Parser.class).values());</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var3</span> <span class="operator">=</span> beans.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// spirngboot会扫描ioc容器中以下所有类型的bean，并添加到WebConversionService中</span></span><br><span class="line">    <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> var3.next();</span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> GenericConverter) &#123;</span><br><span class="line">            registry.addConverter((GenericConverter)bean);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Converter) &#123;</span><br><span class="line">            registry.addConverter((Converter)bean);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Formatter) &#123;</span><br><span class="line">            registry.addFormatter((Formatter)bean);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Printer) &#123;</span><br><span class="line">            registry.addPrinter((Printer)bean);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> Parser) &#123;</span><br><span class="line">            registry.addParser((Parser)bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-2、POST请求解决思路"><a href="#4-2、POST请求解决思路" class="headerlink" title="4.2、POST请求解决思路"></a>4.2、POST请求解决思路</h2><p>通过异常源码分析我们可以得知，由于jackson也就是ObjectMapper对象在默认情况下并不能完成LocalDateTime类型的解析，所有需要对jackson进行配置；通过阅读源码，以下有两种解决方式：</p><ul><li><p>配置类注入Jackson2ObjectMapperBuilderCustomizer类型的Bean对jackson进行配置(推荐)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(Jackson2ObjectMapperBuilder.class)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">JacksonObjectMapperBuilderConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    Jackson2ObjectMapperBuilder <span class="title function_">jacksonObjectMapperBuilder</span><span class="params">(ApplicationContext applicationContext,</span></span><br><span class="line"><span class="params">            List&lt;Jackson2ObjectMapperBuilderCustomizer&gt; customizers)</span> &#123;</span><br><span class="line">        <span class="type">Jackson2ObjectMapperBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jackson2ObjectMapperBuilder</span>();</span><br><span class="line">        builder.applicationContext(applicationContext);</span><br><span class="line">        <span class="comment">// ioc容器中获取所有Jackson2ObjectMapperBuilderCustomizer类型的bean, 调用customize方法配置Jackson2ObjectMapperBuilder</span></span><br><span class="line">        customize(builder, customizers);</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">customize</span><span class="params">(Jackson2ObjectMapperBuilder builder,</span></span><br><span class="line"><span class="params">            List&lt;Jackson2ObjectMapperBuilderCustomizer&gt; customizers)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Jackson2ObjectMapperBuilderCustomizer customizer : customizers) &#123;</span><br><span class="line">            customizer.customize(builder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>直接注入ObjectMapper类型的Bean进行覆盖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(Jackson2ObjectMapperBuilder.class)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">JacksonObjectMapperConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    ObjectMapper <span class="title function_">jacksonObjectMapper</span><span class="params">(Jackson2ObjectMapperBuilder builder)</span> &#123;</span><br><span class="line">        <span class="comment">// 通过Jackson2ObjectMapperBuilder构建出ObjectMapper</span></span><br><span class="line">        <span class="keyword">return</span> builder.createXmlMapper(<span class="literal">false</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="五、解决方案落地"><a href="#五、解决方案落地" class="headerlink" title="五、解决方案落地"></a>五、解决方案落地</h1><h2 id="5-1、GET请求解决方案"><a href="#5-1、GET请求解决方案" class="headerlink" title="5.1、GET请求解决方案"></a>5.1、GET请求解决方案</h2><ul><li><p>application.yml配置<br>SpringBoot2.3.x以及更高的版本，springmvc增加了日期时间格式配置，既可以解决LocalDateTime类型参数解析，也可以解决Date类型参数解析</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">date:</span> <span class="string">yyyy-MM-dd</span></span><br><span class="line">    <span class="attr">time:</span> <span class="string">HH:mm:ss</span></span><br><span class="line">    <span class="attr">date-time:</span> <span class="string">yyyy-MM-dd</span> <span class="string">HH:mm:ss</span></span><br></pre></td></tr></table></figure></li><li><p>注解配置<br>SpringBoot针对LocalDateTime类型解析增加了@DateTimeFormatter注解，可以在请求参数中加上这个注解完成解析</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalDateTimeController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/resolveRequestParamDateTime&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resolveRequestParamDateTime</span><span class="params">(<span class="meta">@RequestParam</span> <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span> LocalDateTime dateTime)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/resolvePathVariableDateTime/&#123;dateTime&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resolvePathVariableDateTime</span><span class="params">(<span class="meta">@PathVariable</span> <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span> LocalDateTime dateTime)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Java Config注入Bean</p></li></ul><p>在Spring IOC容器中注入Converter，SpringBoot会自动将IOC容器中的Converter放到GenericConversionService中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalDateTimeConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;String, LocalDateTime&gt; <span class="title function_">stringToLocalDateTimeConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Converter</span>&lt;String, LocalDateTime&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> LocalDateTime <span class="title function_">convert</span><span class="params">(String source)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> LocalDateTimeUtil.parseNormDatetime(source);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;String, LocalDate&gt; <span class="title function_">stringToLocalDateConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Converter</span>&lt;String, LocalDate&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> LocalDate <span class="title function_">convert</span><span class="params">(String source)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> LocalDateTimeUtil.parseNormDate(source);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Converter&lt;String, LocalTime&gt; <span class="title function_">stringToLocalTimeConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Converter</span>&lt;String, LocalTime&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> LocalTime <span class="title function_">convert</span><span class="params">(String source)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> LocalDateTimeUtil.parseNormTime(source);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-2、POST请求解决方案"><a href="#5-2、POST请求解决方案" class="headerlink" title="5.2、POST请求解决方案"></a>5.2、POST请求解决方案</h2><ul><li><p>注解配置<br>在实体类的字段上使用@JsonFormat注解配置格式，使用 @JsonSerialize注解配置序列化器，使用 @JsonDeserialize注解配置反序列化器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalDateTimeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/resolveBodyDateTime&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resolveBodyDateTime</span><span class="params">(<span class="meta">@RequestBody</span> ResolveBody body)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ResolveBody</span> &#123;</span><br><span class="line">        <span class="meta">@JsonSerialize(using = LocalDateTimeSerializer.class)</span></span><br><span class="line">        <span class="meta">@JsonDeserialize(using = LocalDateTimeDeserializer.class)</span></span><br><span class="line">        <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> LocalDateTime dateTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Java Config注入Bean</p></li></ul><p>在Spring IOC容器中注入Jackson2ObjectMapperBuilderCustomizer类型的Bean可以对Jackson进行自定义配置；也可以直接注入一个ObjectMapper进行替换</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalDateTimeConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="title function_">jackson2ObjectMapperBuilderCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Jackson2ObjectMapperBuilderCustomizer</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">customize</span><span class="params">(Jackson2ObjectMapperBuilder jacksonObjectMapperBuilder)</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">JavaTimeModule</span> <span class="variable">javaTimeModule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaTimeModule</span>();</span><br><span class="line">                javaTimeModule.addSerializer(LocalDateTime.class, <span class="keyword">new</span> <span class="title class_">LocalDateTimeSerializer</span>(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)));</span><br><span class="line">                javaTimeModule.addSerializer(LocalDate.class, <span class="keyword">new</span> <span class="title class_">LocalDateSerializer</span>(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>)));</span><br><span class="line">                javaTimeModule.addSerializer(LocalTime.class, <span class="keyword">new</span> <span class="title class_">LocalTimeSerializer</span>(DateTimeFormatter.ofPattern(<span class="string">&quot;HH:mm:ss&quot;</span>)));</span><br><span class="line"></span><br><span class="line">                javaTimeModule.addDeserializer(LocalDateTime.class, <span class="keyword">new</span> <span class="title class_">LocalDateTimeDeserializer</span>(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)));</span><br><span class="line">                javaTimeModule.addDeserializer(LocalDate.class, <span class="keyword">new</span> <span class="title class_">LocalDateDeserializer</span>(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>)));</span><br><span class="line">                javaTimeModule.addDeserializer(LocalTime.class, <span class="keyword">new</span> <span class="title class_">LocalTimeDeserializer</span>(DateTimeFormatter.ofPattern(<span class="string">&quot;HH:mm:ss&quot;</span>)));</span><br><span class="line"></span><br><span class="line">                jacksonObjectMapperBuilder</span><br><span class="line">                        .modules(javaTimeModule)</span><br><span class="line">                        .featuresToDisable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES)</span><br><span class="line">                        .featuresToDisable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)</span><br><span class="line">                        .simpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)</span><br><span class="line">                        .timeZone(TimeZone.getTimeZone(<span class="string">&quot;GMT+8&quot;</span>))</span><br><span class="line">                        .locale(Locale.CHINA);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-tags"><a href="/tags/springboot/" rel="tag"># springboot</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2024/01/01/springboot/springboot_Jar_thin/" rel="prev" title="SpringBoot Jar瘦身"><i class="fa fa-chevron-left"></i> SpringBoot Jar瘦身</a></div><div class="post-nav-item"><a href="/2024/04/19/life/sharing_movie/" rel="next" title="电影清单">电影清单 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8LocalDateTime"><span class="nav-number">1.</span> <span class="nav-text">一、为什么使用LocalDateTime</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8LocalDateTime%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">2.</span> <span class="nav-text">二、使用LocalDateTime遇到的问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%BC%82%E5%B8%B8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">三、异常源码分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="nav-number">4.</span> <span class="nav-text">四、解决思路</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1%E3%80%81GET%E8%AF%B7%E6%B1%82%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="nav-number">4.1.</span> <span class="nav-text">4.1、GET请求解决思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2%E3%80%81POST%E8%AF%B7%E6%B1%82%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="nav-number">4.2.</span> <span class="nav-text">4.2、POST请求解决思路</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E8%90%BD%E5%9C%B0"><span class="nav-number">5.</span> <span class="nav-text">五、解决方案落地</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1%E3%80%81GET%E8%AF%B7%E6%B1%82%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">5.1.</span> <span class="nav-text">5.1、GET请求解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2%E3%80%81POST%E8%AF%B7%E6%B1%82%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">5.2.</span> <span class="nav-text">5.2、POST请求解决方案</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">独辟蹊径的鱼</p><div class="site-description" itemprop="description">一个简单的博客</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://zx.js.cool/" title="https:&#x2F;&#x2F;zx.js.cool&#x2F;" rel="noopener" target="_blank">zx大佬</a></li><li class="links-of-blogroll-item"><a href="https://book.xuguan.eu.org/" title="https:&#x2F;&#x2F;book.xuguan.eu.org&#x2F;" rel="noopener" target="_blank">Book Searcher</a></li></ul></div><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="110" src="//music.163.com/outchain/player?type=0&id=8635644841&auto=0&height=90"></iframe></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">独辟蹊径的鱼</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/pjax/0.2.8/pjax.min.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script src="/js/local-search.js"></script><div id="pjax"></div><script src="/js/cursor/text.js"></script><script src="/js/my_js/leave_change_tile.js"></script></body></html>